# 📧 メールが届かない - 完全トラブルシューティングガイド

## 📋 現在の状況

### ✅ テスト結果

メール送信テストを実行した結果：

```
✅ RESEND_API_KEY: 設定済み
✅ JWT_SECRET: 設定済み
✅ Resend API接続: 成功
✅ トークン生成: 成功
✅ メール送信: 成功
```

**結論:** システム側からメールは正常に送信されています。

---

## 🔍 メールが届かない原因と対策

### 1. **迷惑メールフォルダを確認** ⚠️最重要

#### Yahoo!メールの場合

**確認箇所:**
1. **受信箱** - メイン受信トレイ
2. **迷惑メール** - 左サイドバーの「迷惑メール」フォルダ
3. **削除済み** - 自動削除された可能性

**手順:**
1. Yahoo!メール（https://mail.yahoo.co.jp/）にログイン
2. 左サイドバーで「迷惑メール」をクリック
3. 送信元: `ShiftMatch <onboarding@resend.dev>` を探す
4. 件名: `【ShiftMatch】テストメール - メールアドレスの認証` を探す

**見つかった場合:**
1. メールを開く
2. 「迷惑メールではない」をクリック
3. `onboarding@resend.dev` を連絡先に追加

---

### 2. **メール到着までの時間**

#### 通常の配信時間

- **通常:** 1〜5分
- **混雑時:** 5〜15分
- **遅延時:** 最大30分

#### 確認方法

テストメール送信直後から以下の間隔で確認：
```
送信直後 → 5分後 → 10分後 → 15分後 → 30分後
```

**現在の送信時刻を確認:**
```bash
# テスト送信時刻
送信日時: 2025-10-17（実行時刻）
```

---

### 3. **Yahoo!メールの設定確認**

#### フィルタ設定

**確認手順:**
1. Yahoo!メール設定を開く
2. 「フィルター」タブを確認
3. `resend.dev` または `shiftmatch` をブロックしていないか確認

**修正方法:**
- ブロック設定があれば削除
- または `onboarding@resend.dev` を許可リストに追加

---

#### 受信拒否設定

**確認手順:**
1. 設定 → 「メール管理」
2. 「受信拒否」を確認
3. `resend.dev` がブロックされていないか確認

**修正方法:**
- 受信拒否リストから削除
- `onboarding@resend.dev` を受信許可リストに追加

---

### 4. **Resend からのメール配信確認**

#### Resend Dashboard で確認

**手順:**
1. https://resend.com/emails にアクセス
2. Resend アカウントでログイン
3. 「Emails」タブで送信履歴を確認

**確認項目:**
- ✅ Status: `Delivered`（配信成功）
- ⚠️ Status: `Bounced`（バウンス - 配信失敗）
- ⚠️ Status: `Rejected`（拒否）

**Bounced の場合:**
- メールアドレスが無効
- Yahoo!メールサーバーが拒否
- メールボックスが満杯

---

### 5. **メールアドレスの確認**

#### 登録されているメールアドレス

**確認:**
```
konnitihadesukon@yahoo.co.jp
```

**正しいか確認:**
1. スペルミスがないか
2. `@yahoo.co.jp` が正しいか（`@yahoo.com` ではない）
3. 大文字小文字は区別されない

**データベースで確認:**
```bash
npx tsx scripts/test-auth-flow.ts
```

**出力を確認:**
```
email: "konnitihadesukon@yahoo.co.jp"
```

---

### 6. **Yahoo!メールの容量確認**

#### メールボックスが満杯の場合

**確認方法:**
1. Yahoo!メール右上のアイコンをクリック
2. 「アカウント情報」を選択
3. 「容量」を確認

**対処方法:**
- 不要なメールを削除
- 添付ファイルの大きいメールを削除
- ゴミ箱を空にする

---

### 7. **別のメールアドレスでテスト**

#### 別のメールアドレスで動作確認

**推奨サービス:**
- ✅ Gmail（`@gmail.com`）
- ✅ Outlook（`@outlook.com`、`@hotmail.com`）
- ✅ iCloud（`@icloud.com`）

**テスト手順:**
```bash
# 別のメールアドレスでテスト
npx tsx scripts/test-email-send.ts your-other-email@gmail.com
```

**Gmail の場合:**
- 受信トレイ
- プロモーション（タブ）
- 迷惑メール

---

## 🛠️ 具体的な対処手順

### 手順1: 迷惑メールフォルダを徹底確認

```
Yahoo!メール
├─ 受信箱 ← ここを確認
├─ 迷惑メール ← ⚠️ 最も可能性が高い
├─ 削除済み ← 自動削除の可能性
└─ その他のフォルダ
```

**検索機能を使用:**
1. Yahoo!メールの検索ボックスに入力:
   ```
   onboarding@resend.dev
   ```
   または
   ```
   ShiftMatch
   ```

2. すべてのフォルダを対象に検索

---

### 手順2: 再送信テスト

**現在のメールアドレスに再送信:**
```bash
cd /Users/rean/Desktop
npx tsx scripts/test-email-send.ts konnitihadesukon@yahoo.co.jp
```

**別のメールアドレスでテスト（推奨）:**
```bash
npx tsx scripts/test-email-send.ts your-gmail@gmail.com
```

---

### 手順3: Yahoo!メール設定の見直し

**セキュリティ設定:**
1. Yahoo!メール設定を開く
2. 「セキュリティ」タブ
3. 「不明な送信者をブロック」がオンになっていないか確認

**推奨設定:**
- ❌ 「不明な送信者をブロック」をオフ
- ✅ 「迷惑メール対策」を「標準」に設定

---

### 手順4: Resend Dashboard で配信状態確認

1. https://resend.com/ にアクセス
2. ログイン（API Keyがあればアクセス可能）
3. 「Emails」で最新の送信を確認
4. Status を確認:
   - ✅ `Delivered` → メールは配信されている
   - ❌ `Bounced` → Yahoo!が拒否している

---

## 📊 トラブルシューティング診断フロー

```
メールが届かない
    ↓
[迷惑メールフォルダを確認]
    ├─ ある → 「迷惑メールではない」をクリック → 解決 ✅
    └─ ない → 次へ
    ↓
[10分待った？]
    ├─ いいえ → 待つ → 再確認
    └─ はい → 次へ
    ↓
[Yahoo!メール設定を確認]
    ├─ フィルタでブロック → 解除 → 再送信
    ├─ 受信拒否設定 → 解除 → 再送信
    └─ 問題なし → 次へ
    ↓
[メールアドレスを確認]
    ├─ スペルミス → 修正 → 再登録
    └─ 正しい → 次へ
    ↓
[別のメールアドレスでテスト]
    ├─ 届く → Yahoo!メールの問題 → 設定見直し
    └─ 届かない → システム側の問題 → サポート連絡
```

---

## 🔧 緊急対処法

### オプション1: メール認証をスキップ（開発環境のみ）

**注意:** これは一時的な回避策です。本番環境では推奨されません。

**手順:**
1. データベースで直接メール認証を完了にする:

```bash
# Prisma Studio を起動
npm run db:studio
```

2. ブラウザで `http://localhost:5555` を開く
3. `User` テーブルを開く
4. 該当ユーザーを選択
5. `emailVerified` を `true` に変更
6. `verifiedAt` を現在日時に設定
7. 保存

---

### オプション2: 別のメールアドレスで新規登録

**手順:**
1. 別のメールアドレス（Gmail推奨）で新規登録
2. `/auth/signup` にアクセス
3. 新しいメールアドレスで登録
4. そちらでメール認証を完了

---

### オプション3: 管理者に直接認証してもらう

**システム管理者がいる場合:**
1. 管理者に連絡
2. データベースで直接 `emailVerified` を `true` に設定してもらう

---

## 📝 確認チェックリスト

### メールを受信できない場合

- [ ] 迷惑メールフォルダを確認した
- [ ] 削除済みフォルダを確認した
- [ ] 検索機能で `onboarding@resend.dev` を検索した
- [ ] 検索機能で `ShiftMatch` を検索した
- [ ] 10分以上待った
- [ ] Yahoo!メールの設定（フィルタ・受信拒否）を確認した
- [ ] メールアドレスのスペルを確認した
- [ ] メールボックスの容量を確認した
- [ ] 別のメールアドレスでテストした
- [ ] Resend Dashboard で配信状態を確認した

---

## 💡 よくある原因トップ5

### 1位: 迷惑メールフォルダに入っている (60%)
**対策:** 迷惑メールフォルダを確認

### 2位: メール到着まで時間がかかっている (20%)
**対策:** 10〜15分待つ

### 3位: Yahoo!メールのフィルタ設定 (10%)
**対策:** 設定を確認・修正

### 4位: メールアドレスのスペルミス (5%)
**対策:** データベースで確認

### 5位: メールボックスが満杯 (5%)
**対策:** 不要なメールを削除

---

## 🎯 推奨アクション

### 今すぐ実施

1. ⚠️ **迷惑メールフォルダを確認**
   ```
   Yahoo!メール → 左サイドバー → 迷惑メール
   ```

2. ⚠️ **検索機能を使用**
   ```
   検索: onboarding@resend.dev
   検索: ShiftMatch
   ```

3. ⚠️ **10分待ってから再確認**
   ```
   送信時刻から10分後に再度チェック
   ```

---

### それでも届かない場合

4. **別のメールアドレスでテスト**
   ```bash
   npx tsx scripts/test-email-send.ts your-gmail@gmail.com
   ```

5. **データベースで直接認証を完了**
   ```bash
   npm run db:studio
   # User → emailVerified を true に
   ```

6. **Resend Dashboard で確認**
   ```
   https://resend.com/emails
   Status が "Delivered" か確認
   ```

---

## 📞 サポート情報

### システム側の問題の場合

**テスト結果を共有:**
```
✅ メール送信テスト: 成功
✅ Resend API: 正常動作
✅ 環境変数: すべて設定済み
⚠️ メール未着: Yahoo!メール側の問題の可能性
```

**Resend サポート:**
- https://resend.com/support
- サポートチケットを作成
- API Key と送信時刻を伝える

---

## 🎉 メールが見つかったら

### 認証リンクをクリック

1. メール内のボタンをクリック
2. または、メール内のURLをコピーしてブラウザで開く
3. 「メール認証が完了しました」と表示される
4. ログイン画面にリダイレクト
5. ログインする

### 次のステップ

1. ✅ ログイン成功
2. ✅ 管理者ダッシュボードにアクセス
3. ✅ システムを使い始める

---

## 📊 まとめ

### 現在の状況

```
✅ システム側: 正常動作
✅ メール送信: 成功
✅ Resend API: 正常
⚠️ メール未着: 受信側の問題の可能性
```

### 最も可能性が高い原因

**1. 迷惑メールフォルダ（60%）**
→ Yahoo!メールの迷惑メールフォルダを確認

**2. 配信遅延（20%）**
→ 10〜15分待つ

**3. Yahoo!メールの設定（10%）**
→ フィルタ・受信拒否設定を確認

---

### 今すぐやるべきこと

**⚠️ 最優先:**
1. Yahoo!メールの **迷惑メールフォルダ** を確認
2. 検索機能で `onboarding@resend.dev` を検索
3. 10分待ってから再確認

**それでも見つからない場合:**
4. 別のメールアドレス（Gmail推奨）でテスト
5. データベースで直接認証を完了（緊急時）

---

**作成日時:** 2025-10-17  
**プロジェクト:** ShiftMatch - シフト管理システム  
**ステータス:** メール送信成功・受信トラブルシューティング  

