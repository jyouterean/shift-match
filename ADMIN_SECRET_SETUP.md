# 管理者専用エリア セットアップガイド

## 📋 概要

管理者専用エリア（`/admin/secret`）は、新規会社の初回登録専用のページです。
セキュリティ強化のため、シークレットパスワードで保護されています。

---

## 🔐 デフォルトパスワード

**パスワード:** `admin2025`

**アクセスURL:**
- 本番: https://shiftmatch.net/admin/secret
- 本番: https://www.shiftmatch.net/admin/secret

---

## 🚀 使用方法

### 1. アクセス

ブラウザで `/admin/secret` にアクセスします。

### 2. パスワード入力

シークレットパスワード `admin2025` を入力して「確認」ボタンをクリック。

### 3. 会社情報入力

パスワード認証後、以下の情報を入力します：

- **会社名** (必須)
- **管理者名** (必須)
- **管理者メールアドレス** (必須)
- **管理者パスワード** (必須、8文字以上)
- **管理者電話番号** (任意)

### 4. 登録完了

登録が完了すると、会社コードが表示されます。
このコードは従業員招待時に使用します。

### 5. ログイン

登録した管理者メールアドレスとパスワードで `/auth/signin` からログインします。

---

## 🔧 パスワード変更方法

### デフォルトパスワードを変更する場合

#### 方法1: スクリプトを使用

```bash
npm run generate-secret-hash
```

プロンプトに従って新しいパスワードを入力すると、ハッシュが生成されます。

#### 方法2: 手動で生成

```bash
node -e "const bcrypt = require('bcryptjs'); bcrypt.hash('あなたの新しいパスワード', 10).then(hash => console.log(hash))"
```

### 環境変数の更新

#### ローカル環境（.env.local）

```env
ADMIN_SECRET_PASSWORD_HASH="生成されたハッシュ"
```

#### Vercel本番環境

```bash
# 既存の値を削除
npx vercel env rm ADMIN_SECRET_PASSWORD_HASH production

# 新しい値を追加
echo 'y' | npx vercel env rm ADMIN_SECRET_PASSWORD_HASH production
printf '%s\n' '生成されたハッシュ' | npx vercel env add ADMIN_SECRET_PASSWORD_HASH production

# 再デプロイ
npx vercel --prod
```

---

## 🛡️ セキュリティ機能

### レート制限

- **制限:** 5回の試行 / 15分
- **超過時:** 429エラー、待機時間が表示されます

### bcryptハッシュ化

- パスワードはbcryptでハッシュ化されています
- ソルトラウンド: 10
- 環境変数に保存（プレーンテキストは保存されません）

### HTTPS強制

- 本番環境では常にHTTPS経由でアクセス
- HSTS preload対応

---

## 📝 トラブルシューティング

### 「パスワードが正しくありません」と表示される

1. パスワードが正しいか確認
   - デフォルト: `admin2025`
   - 大文字小文字を区別します

2. 環境変数が設定されているか確認
   ```bash
   # ローカル
   cat .env.local | grep ADMIN_SECRET_PASSWORD_HASH
   
   # Vercel
   npx vercel env ls
   ```

3. 環境変数が正しく読み込まれているか確認
   - ローカルサーバーを再起動
   - Vercelは自動的に再デプロイ

### 「設定エラーが発生しました」と表示される

環境変数 `ADMIN_SECRET_PASSWORD_HASH` が設定されていません。
上記の「パスワード変更方法」を参照して設定してください。

### 「試行回数が多すぎます」と表示される

レート制限に達しました。
表示されている待機時間（通常15分）が経過してから再試行してください。

---

## 🔄 本番環境での初回セットアップ手順

### ステップ1: データベースリセット（必要な場合）

```bash
npm run db:reset-users
```

### ステップ2: 環境変数確認

```bash
# ローカル
cat .env.local

# Vercel
npx vercel env ls
```

必須の環境変数:
- ✅ `DATABASE_URL`
- ✅ `NEXTAUTH_URL`
- ✅ `NEXTAUTH_SECRET`
- ✅ `JWT_SECRET`
- ✅ `RESEND_API_KEY`
- ✅ `DOMAIN`
- ✅ `ADMIN_SECRET_PASSWORD_HASH` ← これが追加されました

### ステップ3: 管理者専用エリアにアクセス

1. https://shiftmatch.net/admin/secret にアクセス
2. パスワード `admin2025` を入力
3. 会社情報を入力して登録
4. 表示される会社コードをメモ
5. `/auth/signin` からログイン

### ステップ4: 初期設定

1. **営業所の登録**
   - メニュー → 営業所 → 追加

2. **単価タイプの登録**
   - メニュー → 単価設定 → 追加

3. **従業員の招待**
   - メニュー → メンバー → 追加
   - 会社コードを使用

4. **必要人数の設定**
   - 営業所 → 📅 必要人数設定

---

## 💡 ベストプラクティス

### パスワード管理

1. ✅ デフォルトパスワードを変更する
2. ✅ 強力なパスワードを使用（12文字以上推奨）
3. ✅ パスワードを安全に共有（暗号化通信）
4. ✅ 定期的にパスワードを変更

### アクセス制御

1. ✅ 管理者専用エリアのURLを公開しない
2. ✅ 初回登録後は通常のサインイン画面を使用
3. ✅ 監査ログで不正アクセスを監視
4. ✅ レート制限を有効にする

### データ保護

1. ✅ 本番環境はHTTPSのみ
2. ✅ 環境変数をGitにコミットしない
3. ✅ データベースバックアップを定期実行
4. ✅ セキュリティアップデートを適用

---

## 📞 サポート

問題が解決しない場合は、以下を確認してください：

1. ブラウザのコンソールにエラーがないか
2. Vercelのデプロイログにエラーがないか
3. データベース接続が正常か
4. 環境変数がすべて設定されているか

---

## 🎯 まとめ

- ✅ デフォルトパスワード: `admin2025`
- ✅ アクセスURL: `/admin/secret`
- ✅ レート制限: 5回/15分
- ✅ 環境変数: `ADMIN_SECRET_PASSWORD_HASH`
- ✅ ハッシュ生成: `npm run generate-secret-hash`
- ✅ セキュリティ: bcrypt + HTTPS + レート制限

本番環境での初回会社登録の準備が整いました！🚀✨

