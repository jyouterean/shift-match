# 監査ログレビュー機能ガイド

**実装日:** 2025年10月15日  
**ステータス:** ✅ 完了

---

## 概要

監査ログレビュー機能は、アプリケーションのセキュリティ状態を定期的に確認し、異常なパターンや潜在的なセキュリティ脅威を検出するための管理ツールです。

---

## アクセス方法

### URL
`https://your-domain.com/admin/audit-logs/review`

### アクセス権限
- **OWNER** ロール
- **ADMIN** ロール

### ナビゲーション
管理画面メニュー → **セキュリティレビュー**

---

## 主な機能

### 1. 統計サマリー

#### 表示される指標
- **総イベント数**: 選択期間内のすべての操作
- **クリティカルイベント**: 削除、アクセス拒否、ログイン失敗など
- **アクティブユーザー数**: 期間内に操作を行ったユーザー数
- **期間**: 選択した分析期間（7日、14日、30日、90日）

### 2. セキュリティアラート

自動的に検出される異常パターン：

#### 🔴 エラーレベルのアラート
- **DDoS攻撃の疑い**
  - 同一IPから1000回以上のアクセス
  - メッセージ例: `IPアドレス 192.168.1.1 から過去7日間で1500回のアクセスが検出されました（DDoS攻撃の可能性）`

#### 🟡 警告レベルのアラート
- **過剰なログイン失敗**
  - 10回以上のログイン失敗
  - メッセージ例: `過去7日間で15回のログイン失敗が検出されました`

- **過剰なアクセス拒否**
  - 5回以上のアクセス拒否
  - メッセージ例: `過去7日間で8回のアクセス拒否が検出されました`

- **大量の削除操作**
  - 特定ユーザーが10回以上の削除操作
  - メッセージ例: `田中太郎さんが過去7日間で12回の削除操作を実行しました`

- **短時間での大量操作**
  - 過去1時間で100件以上の操作
  - メッセージ例: `過去1時間で150件の操作が実行されました`

#### 🔵 情報レベルのアラート
- **異常に多い活動**
  - ユーザーの活動が平均の3倍以上
  - メッセージ例: `鈴木花子さんの活動が平均の3倍以上です（450件）`

### 3. 詳細統計

#### 上位アクション
- 最も実行されたアクションTOP5
- 各アクションの実行回数
- 例:
  - `REPORT_VIEW`: 1,234回
  - `SHIFT_CREATE`: 567回
  - `USER_UPDATE`: 234回

#### アクティブユーザー
- 最も活発なユーザーTOP5
- 各ユーザーの操作件数
- 例:
  - 田中太郎: 450件
  - 鈴木花子: 320件
  - 佐藤次郎: 280件

---

## 使い方

### 基本的な使い方

1. **期間を選択**
   - 7日間、14日間、30日間、90日間から選択
   - デフォルト: 7日間

2. **アラートを確認**
   - 赤色（エラー）のアラートを最優先で確認
   - 黄色（警告）のアラートを次に確認
   - 青色（情報）のアラートは参考情報

3. **統計を分析**
   - クリティカルイベントが多い場合は要注意
   - 上位アクションから利用パターンを把握
   - アクティブユーザーから異常な活動を検出

4. **詳細を確認**
   - 「すべてのログを表示」ボタンで監査ログページへ
   - 特定のユーザーやアクションでフィルタリング

### 定期的なレビュー推奨

| 頻度 | 期間 | 目的 |
|------|------|------|
| **毎日** | 7日間 | 即座の脅威検出 |
| **毎週** | 14日間 | 傾向の把握 |
| **毎月** | 30日間 | パターン分析 |
| **四半期** | 90日間 | 長期的な傾向 |

---

## アラート対応ガイド

### 🔴 DDoS攻撃の疑い

**症状**: 同一IPから異常に多いアクセス

**対応手順**:
1. IPアドレスを確認
2. 正規のユーザーか、攻撃者かを判断
3. 攻撃者の場合:
   - IPをブロック（ファイアウォール/CDN）
   - Vercelのセキュリティ設定を確認
4. データベースへの影響を確認

### 🟡 過剰なログイン失敗

**症状**: ブルートフォース攻撃の可能性

**対応手順**:
1. 失敗したアカウントを特定
2. 該当ユーザーに通知
3. 必要に応じてアカウントを一時ロック
4. パスワードリセットを推奨

### 🟡 大量の削除操作

**症状**: データ漏洩や不正操作の可能性

**対応手順**:
1. 削除されたデータを確認
2. ユーザーに事情を確認
3. 不正操作の場合:
   - アカウントを停止
   - データのバックアップから復元
   - 権限を見直し

### 🟡 短時間での大量操作

**症状**: Bot や自動スクリプトの可能性

**対応手順**:
1. 操作内容を確認
2. 正規の業務か、不正アクセスかを判断
3. 不正の場合:
   - レート制限を強化
   - CAPTCHAの導入を検討

### 🔵 異常に多い活動

**症状**: 単に活発なユーザー、または乗っ取りの可能性

**対応手順**:
1. 操作内容を確認
2. 通常の業務範囲内かを判断
3. 疑わしい場合:
   - ユーザーに確認
   - 2要素認証を推奨

---

## API仕様

### エンドポイント
`GET /api/admin/audit-logs/review`

### クエリパラメータ
| パラメータ | 型 | デフォルト | 説明 |
|-----------|-----|----------|------|
| `days` | number | 7 | 分析期間（日数） |

### レスポンス例

```json
{
  "period": {
    "days": 7,
    "startDate": "2025-10-08T00:00:00Z",
    "endDate": "2025-10-15T12:00:00Z"
  },
  "stats": {
    "totalEvents": 1234,
    "byAction": {
      "REPORT_VIEW": 567,
      "SHIFT_CREATE": 234
    },
    "byUser": {
      "user-id-1": {
        "name": "田中太郎",
        "count": 450
      }
    },
    "byDay": {
      "2025-10-14": 180,
      "2025-10-15": 95
    },
    "criticalEvents": 12
  },
  "alerts": [
    {
      "type": "warning",
      "message": "過去7日間で15回のログイン失敗が検出されました",
      "timestamp": "2025-10-15T12:00:00Z"
    }
  ],
  "recentLogs": []
}
```

---

## カスタマイズ

### アラート閾値の調整

`app/api/admin/audit-logs/review/route.ts` の以下の値を変更：

```typescript
// ログイン失敗の閾値
if (failedLogins > 10) { // 10 → 任意の値に変更
  alerts.push({ ... })
}

// アクセス拒否の閾値
if (accessDenied > 5) { // 5 → 任意の値に変更
  alerts.push({ ... })
}

// 削除操作の閾値
if (deleteCount > 10) { // 10 → 任意の値に変更
  alerts.push({ ... })
}

// IPアドレスごとのアクセス閾値
if (count > 1000) { // 1000 → 任意の値に変更
  alerts.push({ ... })
}
```

### 新しいアラートの追加

```typescript
// 例: 特定時間帯の大量アクセス
const nightLogs = auditLogs.filter((log) => {
  const hour = log.createdAt.getHours()
  return hour >= 22 || hour <= 6 // 22時〜6時
})

if (nightLogs.length > 50) {
  alerts.push({
    type: 'info',
    message: `深夜時間帯（22時〜6時）に${nightLogs.length}件の操作が検出されました`,
    timestamp: new Date(),
  })
}
```

---

## ベストプラクティス

### 1. 定期的なレビュー
- 毎週月曜日にレビューを実施
- カレンダーにリマインダーを設定

### 2. アラートの優先順位
1. 🔴 エラーレベル → 即座に対応
2. 🟡 警告レベル → 24時間以内に確認
3. 🔵 情報レベル → 週次レビューで確認

### 3. ドキュメント化
- 対応した内容を記録
- 再発防止策を文書化

### 4. チーム共有
- 重要なアラートはチームに共有
- 対応手順をチーム内で標準化

### 5. 継続的な改善
- アラート閾値を定期的に見直し
- 誤検知が多い場合は調整

---

## トラブルシューティング

### 問題: アラートが表示されない

**原因**: 監査ログが記録されていない

**解決策**:
1. `/admin/audit-logs` で監査ログを確認
2. 各APIエンドポイントで監査ログが記録されているか確認
3. データベース接続を確認

### 問題: 統計が正確でない

**原因**: タイムゾーンの問題

**解決策**:
```typescript
// サーバータイムゾーンを確認
console.log('Server timezone:', Intl.DateTimeFormat().resolvedOptions().timeZone)

// 必要に応じて日付変換を調整
const dateKey = log.createdAt.toISOString().split('T')[0]
```

### 問題: パフォーマンスが遅い

**原因**: 大量の監査ログ

**解決策**:
1. データベースインデックスを追加
   ```sql
   CREATE INDEX idx_audit_logs_company_created 
   ON "audit_logs" ("companyId", "createdAt" DESC);
   ```
2. 古いログをアーカイブ
3. 分析期間を短縮

---

## まとめ

### ✅ 主な利点
- 異常なパターンを自動検出
- セキュリティ脅威の早期発見
- データに基づいた意思決定

### 📝 今後の拡張
- メール/Slack通知
- 機械学習による異常検知
- リアルタイムダッシュボード
- カスタムアラートルール

---

**実装者:** AI Security Implementation  
**最終更新:** 2025年10月15日

